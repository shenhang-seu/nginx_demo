<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coveragereport.info.cleaned - hippo/restorer/HippoRestorer.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">hippo/restorer</a> - HippoRestorer.cpp<span style="font-size: 80%;"> (source / <a href="HippoRestorer.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coveragereport.info.cleaned</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">227</td>
            <td class="headerCovTableEntry">283</td>
            <td class="headerCovTableEntryMed">80.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-03-28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">26</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntryMed">78.8 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : #include &quot;HippoRestorer.h&quot;</a>
<span class="lineNum">       2 </span>            : #include &quot;CmeServiceProperties.h&quot;
<span class="lineNum">       3 </span>            : #include &quot;HippoConfig.h&quot;
<span class="lineNum">       4 </span>            : #include &quot;HippoDBTaskFactory.h&quot;
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span><span class="lineCov">         19 : CHippoRestorer::CHippoRestorer(boost::asio::io_service&amp; inIoService)</span>
<span class="lineNum">       7 </span>            :     : m_ioService(inIoService)
<span class="lineNum">       8 </span>            :     , m_restorer(false)
<span class="lineNum">       9 </span>            :     , m_checkingStatus(false)
<span class="lineNum">      10 </span><span class="lineCov">        133 :     , m_workOtterList(new std::vector&lt;std::shared_ptr&lt;IDbRecord&gt; &gt;())</span>
<span class="lineNum">      11 </span>            : {
<span class="lineNum">      12 </span><span class="lineCov">        285 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::CHippoRestorer&quot;);</span>
<span class="lineNum">      13 </span><span class="lineCov">         19 : }</span>
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span><span class="lineCov">         95 : CHippoRestorer::~CHippoRestorer()</span>
<span class="lineNum">      16 </span>            : {
<span class="lineNum">      17 </span><span class="lineCov">        285 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::~CHippoRestorer&quot;);</span>
<a name="18"><span class="lineNum">      18 </span><span class="lineCov">         19 : }</span></a>
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span><span class="lineCov">          4 : bool CHippoRestorer::Initialize(const std::string&amp; inHostIp)</span>
<span class="lineNum">      21 </span>            : {
<span class="lineNum">      22 </span><span class="lineCov">          4 :     m_hostIP = inHostIp;</span>
<span class="lineNum">      23 </span><span class="lineCov">         64 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::Initialize, hostIP=&quot;&lt;&lt;m_hostIP);</span>
<span class="lineNum">      24 </span><span class="lineCov">          8 :     if(m_hostIP.empty())</span>
<span class="lineNum">      25 </span>            :         return false;
<span class="lineNum">      26 </span><span class="lineCov">          6 :     m_poolName = CHippoDBAccess::GetPoolName();</span>
<span class="lineNum">      27 </span><span class="lineCov">          3 :     return true;</span>
<a name="28"><span class="lineNum">      28 </span>            : }</a>
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span><span class="lineCov">          1 : void CHippoRestorer::Release()</span>
<span class="lineNum">      31 </span>            : {
<span class="lineNum">      32 </span>            :     //SafariResult result = UpdateHippoTable(false, false);
<span class="lineNum">      33 </span><span class="lineCov">         15 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::Release&quot;);</span>
<span class="lineNum">      34 </span><span class="lineCov">          1 :     m_restorer = false;</span>
<a name="35"><span class="lineNum">      35 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineCov">          2 : void CHippoRestorer::CheckRestore()</span>
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span><span class="lineCov">          2 :     if(m_restorer == true)</span>
<span class="lineNum">      40 </span>            :     {
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :         m_restorer = false;</span>
<span class="lineNum">      42 </span><span class="lineNoCov">          0 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::CheckRestore get restorer status is true,set to to false&quot;);</span>
<span class="lineNum">      43 </span>            :     }
<span class="lineNum">      44 </span>            :     else
<span class="lineNum">      45 </span>            :     {
<span class="lineNum">      46 </span><span class="lineCov">          2 :         if (m_checkingStatus)</span>
<span class="lineNum">      47 </span>            :         {
<span class="lineNum">      48 </span><span class="lineCov">         16 :             HIPPO_ERROR_THIS(&quot;CHippoRestorer::CheckRestore, still at checking status, status=&quot;&lt;&lt;m_checkingStatus);</span>
<span class="lineNum">      49 </span><span class="lineCov">          2 :             return ;</span>
<span class="lineNum">      50 </span>            :         }
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span><span class="lineCov">          1 :         SafariResult result = QueryHippoRestorer();</span>
<span class="lineNum">      53 </span><span class="lineCov">          1 :         if ( SAFARI_OK == result)</span>
<span class="lineNum">      54 </span><span class="lineCov">          1 :             m_checkingStatus = true;</span>
<span class="lineNum">      55 </span><span class="lineCov">         16 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::CheckRestore, QueryHippoTable result=&quot;&lt;&lt;result);</span>
<span class="lineNum">      56 </span>            :     }
<span class="lineNum">      57 </span>            : }
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span><span class="lineCov">          4 : SafariResult CHippoRestorer::SendSelectRestorer2Hippo()</span>
<span class="lineNum">      60 </span>            : {
<span class="lineNum">      61 </span><span class="lineCov">         60 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::SendSelectRestorer2Hippo&quot;);</span>
<span class="lineNum">      62 </span><span class="lineCov">         20 :     InitiatorSharedPtr initiator =std::make_shared&lt;CHippoCommonInitiator&gt;(m_ioService, CHippoDBAccess::GetHippoBaseUrl(), std::string(HIPPO_SELECT_RESTORER_SERVICE));</span>
<span class="lineNum">      63 </span><span class="lineCov">         16 :     return initiator-&gt;Post([initiator](const RestResponseSharedPtr&amp; inResponse)  mutable </span>
<span class="lineNum">      64 </span>            :     {
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :         initiator.reset();</span>
<span class="lineNum">      66 </span><span class="lineCov">         20 :     });</span>
<a name="67"><span class="lineNum">      67 </span>            : }</a>
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineCov">          2 : SafariResult CHippoRestorer::QueryHippoRestorer()</span>
<span class="lineNum">      70 </span>            : {
<span class="lineNum">      71 </span><span class="lineCov">         30 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryHippoRestorer&quot;);</span>
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span><span class="lineCov">          2 :         boost::posix_time::ptime curTime = boost::posix_time::second_clock::universal_time();</span>
<span class="lineNum">      74 </span><span class="lineCov">          4 :         curTime -= boost::posix_time::seconds(HIPPO_SERVER_TIMEOUT_IN_SECONDS);</span>
<span class="lineNum">      75 </span><span class="lineCov">          2 :         char temp[1024] = {0};</span>
<span class="lineNum">      76 </span><span class="lineCov">         10 :         snprintf(temp, 1024, &quot;%s where ( (HEARTBEATTIME &gt; TO_TIMESTAMP('%s', 'YYYY-MON-DD HH24:MI:SS.FF')) AND (ISRESTORER = 1) AND (STATE = 'REGISTERED') AND (POOLNAME = '%s') )&quot;, CHippoDBManager::GetQuerySqlStatement(TABLE_HIPPO).c_str(),to_simple_string(curTime).c_str(),m_poolName.c_str());</span>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">          2 :         std::string sql = temp;</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineCov">          8 :         return m_hippoDBAccess.AsyncQueryRecord(TABLE_HIPPO, sql, std::bind(&amp;CHippoRestorer::QueryHippoRestorerHandler, this, std::placeholders::_1, std::placeholders::_2));</span>
<span class="lineNum">      81 </span>            : }
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span><span class="lineCov">         10 : void CHippoRestorer::QueryHippoRestorerHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">      84 </span>            : {
<span class="lineNum">      85 </span><span class="lineCov">        160 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryHippoRestorerHandler, inSafariResult=&quot;&lt;&lt;inSafariResult);</span>
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            :         //reset check status
<span class="lineNum">      88 </span><span class="lineCov">         10 :         m_checkingStatus = false;</span>
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span><span class="lineCov">         37 :         if (SAFARI_OK == inSafariResult &amp;&amp; inDbRecordListSharedPtr.get())</span>
<span class="lineNum">      91 </span>            :         {
<span class="lineNum">      92 </span><span class="lineCov">          6 :                 bool isFirstElement = true;</span>
<span class="lineNum">      93 </span>            :                 std::string restoreIP;
<span class="lineNum">      94 </span><span class="lineCov">          6 :                 boost::posix_time::ptime restoreCreateTime;</span>
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span><span class="lineCov">         18 :                 std::vector&lt;std::shared_ptr&lt;IDbRecord&gt; &gt;::iterator iter = inDbRecordListSharedPtr-&gt;begin();</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span><span class="lineCov">        105 :                 for (; iter != inDbRecordListSharedPtr-&gt;end(); iter++)</span>
<span class="lineNum">      99 </span>            :                 {
<span class="lineNum">     100 </span><span class="lineCov">         15 :                         if(iter-&gt;get() == nullptr)</span>
<span class="lineNum">     101 </span>            :                         {
<span class="lineNum">     102 </span><span class="lineCov">         75 :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::QueryHippoRestorerHandler, NULL POINTER&quot;);</span>
<span class="lineNum">     103 </span><span class="lineCov">          5 :                                 continue;</span>
<span class="lineNum">     104 </span>            :                         }
<span class="lineNum">     105 </span>            :                         //CDbHipposRecord* record = (CDbHipposRecord*)iter-&gt;get();
<span class="lineNum">     106 </span><span class="lineCov">         10 :                         std::shared_ptr&lt;CDbHipposRecord&gt; record = std::dynamic_pointer_cast&lt;CDbHipposRecord&gt;(*iter);</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">         10 :                         if (isFirstElement)</span>
<span class="lineNum">     109 </span>            :                         {
<span class="lineNum">     110 </span><span class="lineCov">          4 :                                 isFirstElement = false;</span>
<span class="lineNum">     111 </span><span class="lineCov">          4 :                                 restoreIP = record-&gt;IP();</span>
<span class="lineNum">     112 </span><span class="lineCov">          4 :                                 restoreCreateTime = record-&gt;CreateTime();</span>
<span class="lineNum">     113 </span>            :                         }
<span class="lineNum">     114 </span>            :                         else
<span class="lineNum">     115 </span>            :                         {
<span class="lineNum">     116 </span><span class="lineCov">         12 :                                 if (record-&gt;IP() &lt; restoreIP)</span>
<span class="lineNum">     117 </span>            :                                 {
<span class="lineNum">     118 </span><span class="lineCov">          4 :                                         restoreIP = record-&gt;IP();</span>
<span class="lineNum">     119 </span><span class="lineCov">          4 :                                         restoreCreateTime = record-&gt;CreateTime();</span>
<span class="lineNum">     120 </span>            :                                 }
<span class="lineNum">     121 </span><span class="lineCov">          2 :                                 else if (record-&gt;IP() == restoreIP)</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                                         HIPPO_ERROR_THIS(&quot;CHippoRestorer::QueryHippoRestorerHandler, same ip maybe cause server select resotrer inconsistent&quot;);</span>
<span class="lineNum">     123 </span>            :                         }
<span class="lineNum">     124 </span>            :                 }
<span class="lineNum">     125 </span>            : 
<span class="lineNum">     126 </span><span class="lineCov">          6 :                 if (m_hostIP == restoreIP)</span>
<span class="lineNum">     127 </span>            :                 {
<span class="lineNum">     128 </span><span class="lineCov">         48 :                         HIPPO_DEBUG_THIS(&quot;CHippoRestorer::QueryHippoRestorerHandler, self is restore, ip=&quot;&lt;&lt;m_hostIP);</span>
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineCov">          3 :                         m_restorer = true;</span>
<span class="lineNum">     131 </span><span class="lineCov">          3 :                         SafariResult result = RecoverSession();</span>
<span class="lineNum">     132 </span><span class="lineCov">          3 :                         if (SAFARI_OK != result)</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::QueryHippoRestorerHandler, RecoverSession result=&quot;&lt;&lt;result);</span>
<span class="lineNum">     134 </span>            :                 }
<span class="lineNum">     135 </span>            :                 else
<span class="lineNum">     136 </span>            :                 {
<span class="lineNum">     137 </span><span class="lineCov">          3 :                         SafariResult result = SendSelectRestorer2Hippo();</span>
<span class="lineNum">     138 </span><span class="lineCov">          3 :                         if(result != SAFARI_OK)</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::SendSelectRestorer2Hippo error &quot;&lt;&lt;result);</span>
<span class="lineNum">     140 </span>            :                 }
<span class="lineNum">     141 </span>            :                 
<span class="lineNum">     142 </span><span class="lineCov">         10 :                 return ;</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            : }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            : /*
<span class="lineNum">     147 </span>            : SafariResult CHippoRestorer::QueryHippoTable()
<span class="lineNum">     148 </span>            : {
<span class="lineNum">     149 </span>            :     HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryHippoTable&quot;);
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            :         boost::posix_time::ptime curTime = boost::posix_time::second_clock::universal_time();
<span class="lineNum">     152 </span>            :         curTime -= boost::posix_time::seconds(HIPPO_SERVER_TIMEOUT_IN_SECONDS);
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            :         char temp[1024] = {0};
<span class="lineNum">     155 </span>            :         snprintf(temp, 1024, &quot;%s where ( HEARTBEATTIME &gt; TO_TIMESTAMP('%s', 'YYYY-MON-DD HH24:MI:SS.FF') AND (STATE = 'REGISTERED') AND (POOLNAME = '%s') )&quot;,CHippoDBManager::GetQuerySqlStatement(TABLE_HIPPO).c_str(), to_simple_string(curTime).c_str(),m_poolName.c_str());
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span>            :     std::string sql = temp;
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :     return m_hippoDBAccess.AsyncQueryRecord(TABLE_HIPPO, sql, std::bind(&amp;CHippoRestorer::QueryHippoTableHandler, this, std::placeholders::_1, std::placeholders::_2));
<span class="lineNum">     160 </span>            : }
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span>            : void CHippoRestorer::QueryHippoTableHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)
<span class="lineNum">     163 </span>            : {
<span class="lineNum">     164 </span>            :     HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryHippoTableHandler result=&quot;&lt;&lt;inSafariResult);
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :         //reset check status
<span class="lineNum">     167 </span>            :         m_checkingStatus = false;
<span class="lineNum">     168 </span>            :     
<span class="lineNum">     169 </span>            :     if (SAFARI_OK == inSafariResult)
<span class="lineNum">     170 </span>            :     {
<span class="lineNum">     171 </span>            :         bool isRestorer = CheckSelfIsRestorer(inDbRecordListSharedPtr);
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :                 if (isRestorer)
<span class="lineNum">     174 </span>            :                 {
<span class="lineNum">     175 </span>            :                         SafariResult result = UpdateHippoTable(isRestorer, true);
<span class="lineNum">     176 </span>            :                         if ( SAFARI_OK != result)
<span class="lineNum">     177 </span>            :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::IsRestorer, UpdateHippoTable result=&quot;&lt;&lt;result);
<span class="lineNum">     178 </span>            :                         result = UpdateTimeoutHippo(m_hostIP);
<span class="lineNum">     179 </span>            :                         if ( SAFARI_OK != result)
<span class="lineNum">     180 </span>            :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::IsRestorer, UpdateTimeoutHippo result=&quot;&lt;&lt;result);
<span class="lineNum">     181 </span>            :                         result = RecoverSession();
<span class="lineNum">     182 </span>            :                         if (SAFARI_OK != result)
<span class="lineNum">     183 </span>            :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::IsRestorer, RecoverSession result=&quot;&lt;&lt;result);
<span class="lineNum">     184 </span>            :                 }
<span class="lineNum">     185 </span>            :     }
<span class="lineNum">     186 </span>            : }
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span>            : bool CHippoRestorer::CheckSelfIsRestorer(DbRecordListSharedPtr inDbRecordListSharedPtr)
<span class="lineNum">     189 </span>            : {
<span class="lineNum">     190 </span>            :     HIPPO_ASSERTE_RETURN(inDbRecordListSharedPtr.get(), false);
<span class="lineNum">     191 </span>            :     HIPPO_ASSERTE_RETURN(!inDbRecordListSharedPtr-&gt;empty(), false);
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            : //rule two
<span class="lineNum">     194 </span>            : //if create_time same, select biggest host ip as restorer
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            :     bool isFirstElement = true;
<span class="lineNum">     197 </span>            :         std::string restoreIP;
<span class="lineNum">     198 </span>            :         boost::posix_time::ptime restoreCreateTime;
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :     std::vector&lt;std::shared_ptr&lt;IDbRecord&gt; &gt;::iterator iter = inDbRecordListSharedPtr-&gt;begin();
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :     for (; iter != inDbRecordListSharedPtr-&gt;end(); iter++)
<span class="lineNum">     203 </span>            :     {
<span class="lineNum">     204 </span>            :         if(iter-&gt;get() == nullptr)
<span class="lineNum">     205 </span>            :         {
<span class="lineNum">     206 </span>            :             HIPPO_ERROR_THIS(&quot;CHippoRestorer::CheckSelfIsRestorer, NULL POINTER&quot;);
<span class="lineNum">     207 </span>            :             continue;
<span class="lineNum">     208 </span>            :         }
<span class="lineNum">     209 </span>            :         std::shared_ptr&lt;CDbHipposRecord&gt; record = std::dynamic_pointer_cast&lt;CDbHipposRecord&gt;(*iter);
<span class="lineNum">     210 </span>            :         
<span class="lineNum">     211 </span>            :         if (isFirstElement)
<span class="lineNum">     212 </span>            :         {
<span class="lineNum">     213 </span>            :                         isFirstElement = false;
<span class="lineNum">     214 </span>            :                         restoreIP = record-&gt;IP();
<span class="lineNum">     215 </span>            :                         restoreCreateTime = record-&gt;CreateTime();
<span class="lineNum">     216 </span>            :         }
<span class="lineNum">     217 </span>            :         else
<span class="lineNum">     218 </span>            :         {
<span class="lineNum">     219 </span>            :                         if (record-&gt;IP() &gt; restoreIP)
<span class="lineNum">     220 </span>            :                         {
<span class="lineNum">     221 </span>            :                                 restoreIP = record-&gt;IP();
<span class="lineNum">     222 </span>            :                                 restoreCreateTime = record-&gt;CreateTime();
<span class="lineNum">     223 </span>            :                         }
<span class="lineNum">     224 </span>            :                         else if (record-&gt;IP() == restoreIP)
<span class="lineNum">     225 </span>            :                                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::CheckSelfIsRestorer, same ip maybe cause server select resotrer inconsistent&quot;);
<span class="lineNum">     226 </span>            :         }
<span class="lineNum">     227 </span>            :     }
<span class="lineNum">     228 </span>            :     
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span>            :         if (m_hostIP == restoreIP)
<span class="lineNum">     231 </span>            :         {
<span class="lineNum">     232 </span>            :                 HIPPO_INFO_THIS(&quot;CHippoRestorer::CheckSelfIsRestorer, self is restore, ip=&quot;&lt;&lt;m_hostIP);
<span class="lineNum">     233 </span>            :                 return true;
<span class="lineNum">     234 </span>            :         }
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :     return false;
<span class="lineNum">     237 </span>            : }
<a name="238"><span class="lineNum">     238 </span>            : */</a>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span><span class="lineCov">         23 : bool CHippoRestorer::IsTimeout(boost::posix_time::ptime inCurrentTime, boost::posix_time::ptime&amp; inHeartbeatTime, long inTimeoutInSeconds)</span>
<span class="lineNum">     241 </span>            : {
<span class="lineNum">     242 </span>            :         boost::posix_time::time_duration timeoutDuration(0, 0, inTimeoutInSeconds);
<span class="lineNum">     243 </span><span class="lineCov">         46 :         boost::posix_time::ptime timeoutTime = inHeartbeatTime + timeoutDuration;</span>
<span class="lineNum">     244 </span><span class="lineCov">         23 :         return inCurrentTime &gt; timeoutTime;</span>
<a name="245"><span class="lineNum">     245 </span>            : }</a>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">          1 : SafariResult CHippoRestorer::UpdateTimeoutHippo(const std::string &amp;inHostIp)</span>
<span class="lineNum">     248 </span>            : {
<span class="lineNum">     249 </span><span class="lineCov">         16 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::UpdateTimeoutHippo, hostip =&quot;&lt;&lt;inHostIp);</span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :     char temp[1024] = {0};</span>
<span class="lineNum">     251 </span><span class="lineCov">          3 :     snprintf(temp, 1024, &quot;update wbxhipposerver set ISRESTORER=%d where ( ISRESTORER!=%d AND HIPPOIP!='%s' AND POOLNAME = '%s')&quot;,0,0,inHostIp.c_str(),m_poolName.c_str());</span>
<span class="lineNum">     252 </span><span class="lineCov">          1 :     std::string sql =temp;</span>
<span class="lineNum">     253 </span><span class="lineCov">          4 :     return m_hippoDBAccess.AsyncUpdateRecord(TABLE_HIPPO, sql, std::bind(&amp;CHippoRestorer::UpdateTimeoutHippoHandler, this, std::placeholders::_1, std::placeholders::_2));</span>
<a name="254"><span class="lineNum">     254 </span>            : }</a>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">          2 : void CHippoRestorer::UpdateTimeoutHippoHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">     257 </span>            : {
<span class="lineNum">     258 </span><span class="lineCov">         32 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::UpdateTimeoutHippoHandler, result=&quot;&lt;&lt;inSafariResult);</span>
<span class="lineNum">     259 </span><span class="lineCov">          2 : }</span>
<a name="260"><span class="lineNum">     260 </span>            : </a>
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span><span class="lineCov">          5 : SafariResult CHippoRestorer::RecoverSession()</span>
<span class="lineNum">     263 </span>            : {
<span class="lineNum">     264 </span><span class="lineCov">         80 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::RecoverSession, isRestorer=&quot;&lt;&lt;m_restorer);</span>
<span class="lineNum">     265 </span><span class="lineCov">          5 :     if (!m_restorer)</span>
<span class="lineNum">     266 </span>            :         return SAFARI_OK;
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineCov">          4 :     m_otterTimeoutList.clear();</span>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span><span class="lineCov">          4 :     m_confRecoverMap.clear();</span>
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineCov">          4 :     SafariResult result = QueryOtterTable();</span>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineCov">         72 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::RecoverSession, isRestorer=&quot;&lt;&lt;m_restorer&lt;&lt;&quot;, both server query DB flag=&quot;&lt;&lt;result);</span>
<span class="lineNum">     275 </span>            :     return SAFARI_OK;
<span class="lineNum">     276 </span>            : }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineCov">          5 : SafariResult CHippoRestorer::QueryOtterTable()</span>
<span class="lineNum">     279 </span>            : {
<span class="lineNum">     280 </span><span class="lineCov">         75 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryOtterTable&quot;);</span>
<span class="lineNum">     281 </span>            : /*
<span class="lineNum">     282 </span>            :     std::string sql = CHippoDBManager::GetQuerySqlStatement(TABLE_OTTER) + &quot;where STATE != 'UNREGISTERED' AND POOLNAME = '&quot; + m_poolName + &quot;'&quot;;
<span class="lineNum">     283 </span>            :     if (CHippoConfig::EnableCompareServerVersion())
<span class="lineNum">     284 </span>            :     {
<span class="lineNum">     285 </span>            :         std::string version = ISafariApplication::Instance()-&gt;GetVersion();
<span class="lineNum">     286 </span>            :         sql += &quot; AND VERSION = '&quot; + version + &quot;'&quot;;
<span class="lineNum">     287 </span>            :     }
<span class="lineNum">     288 </span>            : */
<span class="lineNum">     289 </span><span class="lineCov">         10 :         auto dbTask =  CDBTaskFactory::CreateDBTaskQueryAliveInLogicOtter(m_poolName,CHippoConfig::EnableCompareServerVersion(),ISafariApplication::Instance()-&gt;GetVersion());</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineCov">         30 :     return m_hippoDBAccess.AsyncQueryRecord(TABLE_OTTER, dbTask, std::bind(&amp;CHippoRestorer::QueryOtterTableHandler, this, std::placeholders::_1, std::placeholders::_2));</span>
<span class="lineNum">     292 </span>            : }
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineCov">         11 : void CHippoRestorer::QueryOtterTableHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">     295 </span>            : {
<span class="lineNum">     296 </span><span class="lineCov">        112 :     HIPPO_ASSERTE_RETURN_VOID( nullptr != inDbRecordListSharedPtr.get());</span>
<span class="lineNum">     297 </span>            :     //HIPPO_ASSERTE_RETURN_VOID(!inDbRecordListSharedPtr-&gt;empty());
<span class="lineNum">     298 </span><span class="lineCov">          6 :     HIPPO_ASSERTE_RETURN_VOID( SAFARI_OK == inSafariResult);</span>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">         96 :     HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryOtterTableHandler, result=&quot;&lt;&lt;inSafariResult);</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineCov">          6 :     boost::posix_time::ptime curTime = boost::posix_time::microsec_clock::universal_time();</span>
<span class="lineNum">     303 </span><span class="lineCov">         10 :         if (m_workOtterList.get())</span>
<span class="lineNum">     304 </span><span class="lineCov">          6 :         m_workOtterList-&gt;clear();</span>
<span class="lineNum">     305 </span><span class="lineCov">         44 :     for (std::shared_ptr&lt;IDbRecord&gt; bRecord : *inDbRecordListSharedPtr)</span>
<span class="lineNum">     306 </span>            :     {
<span class="lineNum">     307 </span><span class="lineCov">         14 :         if (bRecord.get() != nullptr)</span>
<span class="lineNum">     308 </span>            :         {
<span class="lineNum">     309 </span><span class="lineCov">         14 :             std::shared_ptr&lt;CDbOttersRecord&gt; record = std::dynamic_pointer_cast&lt;CDbOttersRecord&gt;(bRecord);</span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span><span class="lineCov">         14 :                         boost::posix_time::ptime heartbeatTime = record-&gt;HeartbeatTime();</span>
<span class="lineNum">     312 </span><span class="lineCov">         14 :                         if (curTime &lt; heartbeatTime)</span>
<span class="lineNum">     313 </span>            :                         {
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                                 HIPPO_WARNING_THIS(&quot;CHippoRestorer::QueryOtterTableHandler, heartbeat more than current time, maybe server's time isn't sync, otter server=&quot;&lt;&lt;record-&gt;IP()&lt;&lt;&quot;heartbeat time=&quot;&lt;&lt;to_simple_string(heartbeatTime)&lt;&lt;&quot;, current time=&quot;&lt;&lt;to_simple_string(curTime));</span>
<span class="lineNum">     315 </span>            :                                 continue;
<span class="lineNum">     316 </span>            :                         }
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            :                         //check still live otter server,  state=&quot;REGISTERED&quot; and load &lt; MaxLoad
<span class="lineNum">     319 </span><span class="lineCov">         28 :             if( (record-&gt;State() == &quot;REGISTERED&quot;)  &amp;&amp; (record-&gt;Load() &lt; record-&gt;MaxLoad()) &amp;&amp; !IsTimeout(curTime, heartbeatTime, HIPPO_SERVER_TIMEOUT_IN_SECONDS))</span>
<span class="lineNum">     320 </span>            :             {
<span class="lineNum">     321 </span><span class="lineCov">          8 :                 m_workOtterList-&gt;push_back(bRecord);</span>
<span class="lineNum">     322 </span>            :             }
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span>            :                         //timeout server
<span class="lineNum">     325 </span><span class="lineCov">         14 :             if (IsTimeout(curTime, heartbeatTime, HIPPO_SERVER_TIMEOUT_IN_SECONDS))</span>
<span class="lineNum">     326 </span>            :             {
<span class="lineNum">     327 </span><span class="lineCov">         75 :                 HIPPO_INFO_THIS(&quot;CHippoRestorer::QueryOtterTableHandler get a time out otter ip : &quot;&lt;&lt;record-&gt;IP()&lt;&lt;&quot; curTime : &quot;&lt;&lt;to_simple_string(curTime)&lt;&lt;&quot; heartbeatTime : &quot;&lt;&lt;to_simple_string(heartbeatTime)&lt;&lt;&quot; sequence : &quot;&lt;&lt;record-&gt;Sequence());</span>
<span class="lineNum">     328 </span><span class="lineCov">          6 :                 m_otterTimeoutList.push_back(record-&gt;ID());</span>
<span class="lineNum">     329 </span>            :             }
<span class="lineNum">     330 </span>            :         }
<span class="lineNum">     331 </span>            :         else
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :             HIPPO_ERROR_THIS(&quot;CHippoRestorer::QueryOtterTableHandler, NULL POINTER&quot;);</span>
<span class="lineNum">     333 </span>            :     }
<span class="lineNum">     334 </span><span class="lineCov">          6 :     QuerySessionServerJoinedTable();</span>
<span class="lineNum">     335 </span>            : }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineCov">          7 : SafariResult CHippoRestorer::QuerySessionServerJoinedTable()</span>
<span class="lineNum">     338 </span>            : {
<span class="lineNum">     339 </span><span class="lineCov">        119 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTable, otter list size=&quot;&lt;&lt;m_otterTimeoutList.size());</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineCov">         14 :         if (m_otterTimeoutList.empty())</span>
<span class="lineNum">     342 </span>            :         {
<span class="lineNum">     343 </span><span class="lineCov">         45 :                 HIPPO_INFO_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTable, no any otter server timeout&quot;);</span>
<span class="lineNum">     344 </span>            :                 return SAFARI_OK;
<span class="lineNum">     345 </span>            :         }
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span>            :         //according otter server list
<span class="lineNum">     348 </span>            :         
<span class="lineNum">     349 </span><span class="lineCov">          8 :         if (!m_otterTimeoutList.empty())</span>
<span class="lineNum">     350 </span>            :         {
<span class="lineNum">     351 </span><span class="lineCov">          8 :                 m_sqlSstream.str(&quot;&quot;);</span>
<span class="lineNum">     352 </span><span class="lineCov">          4 :                 m_sqlSstream.clear();</span>
<span class="lineNum">     353 </span><span class="lineCov">         12 :                 m_sqlSstream&lt;&lt; CHippoDBManager::GetQuerySqlStatement(TABLE_SESSION_SERVER_JOINED)&lt;&lt;&quot; WHERE wbxsessionservermap.OTTERID IN (&quot;;</span>
<span class="lineNum">     354 </span><span class="lineCov">          4 :                 bool isFirst = true;</span>
<span class="lineNum">     355 </span><span class="lineCov">          8 :                 auto iter = m_otterTimeoutList.begin();</span>
<span class="lineNum">     356 </span><span class="lineCov">         28 :                 for(;iter != m_otterTimeoutList.end();++iter)</span>
<span class="lineNum">     357 </span>            :                 {
<span class="lineNum">     358 </span><span class="lineCov">          4 :                         if(!isFirst)</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                                 m_sqlSstream&lt;&lt;&quot;,&quot;;</span>
<span class="lineNum">     360 </span>            :                         else
<span class="lineNum">     361 </span>            :                                 isFirst = false;
<span class="lineNum">     362 </span><span class="lineCov">          8 :                         m_sqlSstream&lt;&lt;&quot;'&quot;&lt;&lt;*iter&lt;&lt;&quot;'&quot;;</span>
<span class="lineNum">     363 </span>            :                 }
<span class="lineNum">     364 </span><span class="lineCov">         16 :                 m_sqlSstream&lt;&lt;&quot;)&quot;&lt;&lt;&quot; AND wbxsessioninfo.state IN ('START', 'PAUSE') AND &quot; + CHippoDBManager::GetDBPartitionConditionSqlSessionMap();//&lt;&lt;&quot; AND &quot;&lt;&lt;&quot;wbxsessionservermap.POOLNAME = '&quot;&lt;&lt;m_poolName&lt;&lt;&quot;'&quot;;// do not need pool name</span>
<span class="lineNum">     365 </span><span class="lineCov">          4 :             if (CHippoConfig::EnableCompareServerVersion())</span>
<span class="lineNum">     366 </span>            :             {
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                 std::string version = ISafariApplication::Instance()-&gt;GetVersion();</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :                 m_sqlSstream &lt;&lt; &quot; AND wbxotterserver.version = '&quot; &lt;&lt; version &lt;&lt; &quot;'&quot;;</span>
<span class="lineNum">     369 </span>            :             }
<span class="lineNum">     370 </span><span class="lineCov">         20 :                 m_hippoDBAccess.AsyncQueryRecord(TABLE_SESSION_SERVER_JOINED,m_sqlSstream.str(), std::bind(&amp;CHippoRestorer::QuerySessionServerJoinedTableByOtterHandler, this, std::placeholders::_1, std::placeholders::_2));</span>
<span class="lineNum">     371 </span>            :         }
<span class="lineNum">     372 </span>            :         return SAFARI_OK;
<span class="lineNum">     373 </span>            : }
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">          5 : void CHippoRestorer::QuerySessionServerJoinedTableByOtterHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">     376 </span>            : {
<span class="lineNum">     377 </span><span class="lineCov">         80 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTableByOtterHandler, result=&quot;&lt;&lt;inSafariResult);</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineCov">         10 :         QuerySessionServerJoinedTableHandler(true, inDbRecordListSharedPtr, inSafariResult);</span>
<span class="lineNum">     380 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineCov">          9 : void CHippoRestorer::QuerySessionServerJoinedTableHandler(bool inIsOtter, DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">     383 </span>            : {
<span class="lineNum">     384 </span><span class="lineCov">        162 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTableHandler, result=&quot;&lt;&lt;inSafariResult &lt;&lt;&quot;, inIsOtter=&quot;&lt;&lt;inIsOtter);</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">          9 :         HIPPO_ASSERTE_RETURN_VOID( SAFARI_OK == inSafariResult);</span>
<span class="lineNum">     387 </span><span class="lineCov">        122 :         HIPPO_ASSERTE_RETURN_VOID( NULL != inDbRecordListSharedPtr.get());</span>
<span class="lineNum">     388 </span>            :         //HIPPO_ASSERTE_RETURN_VOID(!inDbRecordListSharedPtr-&gt;empty());
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineCov">          4 :         m_confRecoverMap.clear();</span>
<span class="lineNum">     391 </span><span class="lineCov">         12 :         std::vector&lt;std::shared_ptr&lt;IDbRecord&gt; &gt;::iterator iter = inDbRecordListSharedPtr-&gt;begin();</span>
<span class="lineNum">     392 </span><span class="lineCov">         60 :         for (; iter != inDbRecordListSharedPtr-&gt;end(); ++iter)</span>
<span class="lineNum">     393 </span>            :         {
<span class="lineNum">     394 </span><span class="lineCov">         10 :                 if (iter-&gt;get() != nullptr)</span>
<span class="lineNum">     395 </span>            :                 {
<span class="lineNum">     396 </span><span class="lineCov">         10 :                         std::shared_ptr&lt;CDbSessSvrPairsJoinedRecord&gt; record = std::dynamic_pointer_cast&lt;CDbSessSvrPairsJoinedRecord&gt;(*iter);</span>
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span><span class="lineCov">         20 :                         if (record-&gt;IsDeleted())</span>
<span class="lineNum">     399 </span>            :                                 continue;
<span class="lineNum">     400 </span>            : 
<span class="lineNum">     401 </span><span class="lineCov">         24 :                         if (inIsOtter &amp;&amp; (record-&gt;ParentOtterID() != record-&gt;OtterID()))//only try to failover top otter server</span>
<span class="lineNum">     402 </span>            :                         {
<span class="lineNum">     403 </span><span class="lineCov">         60 :                                 HIPPO_WARNING_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTableHandler, topOtterIP=&quot;&lt;&lt;record-&gt;ParentOtterID()&lt;&lt;&quot;, otterID=&quot;&lt;&lt;record-&gt;OtterID());</span>
<span class="lineNum">     404 </span>            :                                 continue;
<span class="lineNum">     405 </span>            :                         }
<span class="lineNum">     406 </span><span class="lineCov">          6 :                         AddSession(record);</span>
<span class="lineNum">     407 </span>            :                 }
<span class="lineNum">     408 </span>            :                 else
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                         HIPPO_ERROR_THIS(&quot;CHippoRestorer::QuerySessionServerJoinedTableHandler, NULL POINTER&quot;);</span>
<span class="lineNum">     410 </span>            :         }
<span class="lineNum">     411 </span>            :         //begin to failover
<span class="lineNum">     412 </span><span class="lineCov">          4 :         UpdateServerUnregistered(m_otterTimeoutList);</span>
<span class="lineNum">     413 </span><span class="lineCov">         12 :         FailOver(m_confRecoverMap);</span>
<a name="414"><span class="lineNum">     414 </span>            : }</a>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">          6 : SafariResult CHippoRestorer::UpdateServerUnregistered(std::vector&lt;std::string&gt; &amp;inServerList)</span>
<span class="lineNum">     417 </span>            : {
<span class="lineNum">     418 </span><span class="lineCov">         90 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::UpdateServerUnregistered&quot;);</span>
<span class="lineNum">     419 </span><span class="lineCov">          6 :         if(inServerList.empty())</span>
<span class="lineNum">     420 </span>            :         {
<span class="lineNum">     421 </span><span class="lineCov">         75 :                 HIPPO_INFO_THIS(&quot;CHippoRestorer::UpdateServerUnregistered serverlist is empty&quot;);</span>
<span class="lineNum">     422 </span>            :                 return SAFARI_OK;
<span class="lineNum">     423 </span>            :         }
<span class="lineNum">     424 </span><span class="lineCov">          1 :         std::string tablename(DB_TABLE_NAME_OTTER);</span>
<span class="lineNum">     425 </span><span class="lineCov">          1 :         std::string serverIdName(DB_TABLE_ITEM_OTTERID);</span>
<span class="lineNum">     426 </span><span class="lineCov">          1 :         EDBTable table = TABLE_OTTER;</span>
<span class="lineNum">     427 </span><span class="lineCov">          2 :         m_sqlSstream.str(&quot;&quot;);</span>
<span class="lineNum">     428 </span><span class="lineCov">          1 :         m_sqlSstream.clear();</span>
<span class="lineNum">     429 </span><span class="lineCov">          3 :         m_sqlSstream&lt;&lt;&quot;update &quot;&lt;&lt;tablename&lt;&lt;&quot; set state = 'UNREGISTERED' where &quot;&lt;&lt;serverIdName&lt;&lt;&quot; in (&quot;;</span>
<span class="lineNum">     430 </span><span class="lineCov">          1 :         bool isFirst = true;</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 :         auto iter = inServerList.begin();</span>
<span class="lineNum">     432 </span><span class="lineCov">          5 :         for(;iter != inServerList.end();++iter)</span>
<span class="lineNum">     433 </span>            :         {
<span class="lineNum">     434 </span><span class="lineCov">          1 :                 if(!isFirst)</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                         m_sqlSstream&lt;&lt;&quot;,&quot;;</span>
<span class="lineNum">     436 </span>            :                 else
<span class="lineNum">     437 </span>            :                         isFirst = false;
<span class="lineNum">     438 </span><span class="lineCov">          2 :                 m_sqlSstream&lt;&lt;&quot;'&quot;&lt;&lt;*iter&lt;&lt;&quot;'&quot;;</span>
<span class="lineNum">     439 </span>            :         }
<span class="lineNum">     440 </span><span class="lineCov">          1 :         m_sqlSstream&lt;&lt;&quot;)&quot;;//&lt;&lt;&quot; AND POOLNAME = '&quot;&lt;&lt;m_poolName&lt;&lt;&quot;'&quot;;// do not need add poolname</span>
<span class="lineNum">     441 </span><span class="lineCov">          5 :         return m_hippoDBAccess.AsyncUpdateRecord(table,m_sqlSstream.str(),std::bind(&amp;CHippoRestorer::UpdateServerUnregisteredHandler, this, std::placeholders::_1, std::placeholders::_2));</span>
<a name="442"><span class="lineNum">     442 </span>            : }</a>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span><span class="lineCov">          1 : void CHippoRestorer::UpdateServerUnregisteredHandler(DbRecordListSharedPtr inDbRecordListSharedPtr, SafariResult inSafariResult)</span>
<span class="lineNum">     445 </span>            : {
<span class="lineNum">     446 </span><span class="lineCov">         16 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::UpdateServerUnregisteredHandler, result = &quot;&lt;&lt;inSafariResult);</span>
<span class="lineNum">     447 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineCov">          3 : bool CHippoRestorer::AddSession(std::shared_ptr&lt;CDbSessSvrPairsJoinedRecord&gt; inRecord)</span>
<span class="lineNum">     450 </span>            : {
<span class="lineNum">     451 </span><span class="lineCov">          8 :         HIPPO_ASSERTE_RETURN(inRecord.get() != nullptr, false);</span>
<span class="lineNum">     452 </span><span class="lineCov">          6 :         std::string confId = inRecord-&gt;ConfID();</span>
<span class="lineNum">     453 </span><span class="lineCov">          6 :         auto iter = m_confRecoverMap.find(confId);</span>
<span class="lineNum">     454 </span><span class="lineCov">          6 :         if(iter != m_confRecoverMap.end())</span>
<span class="lineNum">     455 </span><span class="lineCov">          5 :                 return iter-&gt;second-&gt;AddSession(inRecord-&gt;SessionID(),inRecord);</span>
<span class="lineNum">     456 </span>            :         else
<span class="lineNum">     457 </span>            :         {
<span class="lineNum">     458 </span><span class="lineCov">          6 :                 FailoverConfSharedPtr confSharedPtr = std::make_shared&lt;CHippoFailoverConference&gt;(confId,inRecord-&gt;SessionLocation());</span>
<span class="lineNum">     459 </span><span class="lineCov">          8 :                 bool ret = confSharedPtr-&gt;AddSession(inRecord-&gt;SessionID(),inRecord);</span>
<span class="lineNum">     460 </span><span class="lineCov">          4 :                 m_confRecoverMap.emplace(std::make_pair(confId, confSharedPtr));</span>
<span class="lineNum">     461 </span><span class="lineCov">          2 :                 return ret;</span>
<span class="lineNum">     462 </span>            :         }
<span class="lineNum">     463 </span>            :         return true;
<span class="lineNum">     464 </span>            : }
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineCov">          5 : void CHippoRestorer::FailOver(FailoverConfMap inConfMap)</span>
<span class="lineNum">     467 </span>            : {
<span class="lineNum">     468 </span><span class="lineCov">         12 :         for(auto iter = inConfMap.begin();iter != inConfMap.end();++iter)</span>
<span class="lineNum">     469 </span>            :         {
<span class="lineNum">     470 </span><span class="lineCov">          6 :                 bool ret = GetNewServer(iter-&gt;second);</span>
<span class="lineNum">     471 </span><span class="lineCov">          2 :                 if(ret == true)</span>
<span class="lineNum">     472 </span>            :                 {
<span class="lineNum">     473 </span>            :                         //fail over
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                         for(auto sIter = iter-&gt;second-&gt;m_sessionMap.begin() ; sIter!=iter-&gt;second-&gt;m_sessionMap.end();++sIter )</span>
<span class="lineNum">     475 </span>            :                         {
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                                 std::shared_ptr&lt;CHippoSessionRecover&gt; sessionFailover = std::make_shared&lt;CHippoSessionRecover&gt;(m_ioService);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                                 sessionFailover-&gt;AddRecord(sIter-&gt;second);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                                 sessionFailover-&gt;SetNewOtter(iter-&gt;second-&gt;GetOtterId(),iter-&gt;second-&gt;GetOtterIp());</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :                                 auto mediaServiceId = CCmeServiceProperties::GetCmeServiceProperties(sessionFailover-&gt;GetSessionType()).GetMediaServiceId();</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                                 sessionFailover-&gt;SetMediaServiceList(iter-&gt;second-&gt;GetMediaServices(mediaServiceId));</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                                 sessionFailover-&gt;SetOtterLocationId(iter-&gt;second-&gt;GetNewOtterLocationId());</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                                 std::string otterIp = sIter-&gt;second-&gt;OtterIP();</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                                 SendStopSessionToOriginalOtter(SAFARI_ERROR_OTTER_TIMEOUT, sIter-&gt;second);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                                 sessionFailover-&gt;TryToFailover([sessionFailover,otterIp](const std::string&amp; inSessionID, SafariResult inResult) mutable</span>
<span class="lineNum">     485 </span>            :                                 {
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                                         HIPPO_INFO(&quot;CHippoRestorer failover result : &quot;&lt;&lt;inResult&lt;&lt;&quot; sessionid : &quot;&lt;&lt;inSessionID&lt;&lt;&quot; server ip&quot;&lt;&lt;otterIp);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                                         sessionFailover.reset();</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                                 });</span>
<span class="lineNum">     489 </span>            :                         }
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :                         if(iter-&gt;second-&gt;m_nbrSessionRecord != nullptr)</span>
<span class="lineNum">     491 </span>            :                         {
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                                 if(iter-&gt;second-&gt;IsOtterEnableNBR())</span>
<span class="lineNum">     493 </span>            :                                 {
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                                         std::shared_ptr&lt;CHippoSessionRecover&gt; sessionFailover = std::make_shared&lt;CHippoSessionRecover&gt;(m_ioService);</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                                         sessionFailover-&gt;AddRecord(iter-&gt;second-&gt;m_nbrSessionRecord);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                                         sessionFailover-&gt;SetNewOtter(iter-&gt;second-&gt;GetOtterId(),iter-&gt;second-&gt;GetOtterIp());</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                                         auto mediaServiceId = CCmeServiceProperties::GetCmeServiceProperties(sessionFailover-&gt;GetSessionType()).GetMediaServiceId();</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                                         sessionFailover-&gt;SetMediaServiceList(iter-&gt;second-&gt;GetMediaServices(mediaServiceId));</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                                         sessionFailover-&gt;SetOtterLocationId(iter-&gt;second-&gt;GetNewOtterLocationId());</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                                         std::string serverIp = iter-&gt;second-&gt;m_nbrSessionRecord-&gt;OtterIP();</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                                         SendStopSessionToOriginalOtter(SAFARI_ERROR_OTTER_TIMEOUT, iter-&gt;second-&gt;m_nbrSessionRecord);</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                                         sessionFailover-&gt;TryToFailover([sessionFailover,serverIp](const std::string&amp; inSessionID, SafariResult inResult) mutable</span>
<span class="lineNum">     503 </span>            :                                         {
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                                                 HIPPO_INFO(&quot;CHippoRestorer failover result : &quot;&lt;&lt;inResult&lt;&lt;&quot; sessionid : &quot;&lt;&lt;inSessionID&lt;&lt;&quot; server ip&quot;&lt;&lt;serverIp);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                                                 sessionFailover.reset();</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                                         });</span>
<span class="lineNum">     507 </span>            :                                 }
<span class="lineNum">     508 </span>            :                                 else
<span class="lineNum">     509 </span>            :                                 {
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                                         StopSession(SAFARI_ERROR_HIPPO_NO_AVAILABLE_NBR_OTTER,iter-&gt;second-&gt;m_nbrSessionRecord);</span>
<span class="lineNum">     511 </span>            :                                 }
<span class="lineNum">     512 </span>            :                         }
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span>            :                 }
<span class="lineNum">     515 </span>            :                 else
<span class="lineNum">     516 </span>            :                 {
<span class="lineNum">     517 </span><span class="lineCov">         14 :                         for(auto sIter = iter-&gt;second-&gt;m_sessionMap.begin() ; sIter!=iter-&gt;second-&gt;m_sessionMap.end();++sIter )</span>
<span class="lineNum">     518 </span>            :                         {
<span class="lineNum">     519 </span><span class="lineCov">          9 :                                 StopSession(SAFARI_ERROR_NO_AVAILABLE_OTTER,sIter-&gt;second);</span>
<span class="lineNum">     520 </span>            :                         }
<span class="lineNum">     521 </span><span class="lineCov">          4 :                         if(iter-&gt;second-&gt;m_nbrSessionRecord != nullptr)</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                                 StopSession(SAFARI_ERROR_NO_AVAILABLE_OTTER,iter-&gt;second-&gt;m_nbrSessionRecord);</span>
<span class="lineNum">     523 </span>            :                 }
<span class="lineNum">     524 </span>            :         }
<span class="lineNum">     525 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span><span class="lineCov">          6 : bool CHippoRestorer::GetNewServer(FailoverConfSharedPtr inConfSharedPtr)</span>
<span class="lineNum">     528 </span>            : {
<span class="lineNum">     529 </span><span class="lineCov">        114 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::GetNewServerIp, inLocation=&quot;&lt;&lt;inConfSharedPtr-&gt;GetLocation());</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineCov">         42 :         DbRecordListSharedPtr selectList = CHippoLoadBalanceManager::Instance()-&gt;SelectOtter(m_workOtterList,inConfSharedPtr-&gt;GetLocation());</span>
<span class="lineNum">     532 </span><span class="lineCov">          8 :         if (nullptr == selectList.get() || selectList-&gt;empty())</span>
<span class="lineNum">     533 </span>            :         {
<span class="lineNum">     534 </span><span class="lineCov">         60 :                 HIPPO_ERROR_THIS(&quot;CHippoRestorer::GetNewServerIp error loadbalance error&quot;);</span>
<span class="lineNum">     535 </span>            :                 return false;
<span class="lineNum">     536 </span>            :         }
<span class="lineNum">     537 </span><span class="lineCov">          2 :         std::size_t index = 0;</span>
<span class="lineNum">     538 </span><span class="lineCov">          7 :         std::vector&lt;std::shared_ptr&lt;IDbRecord&gt; &gt;&amp; recordList= *(selectList.get());</span>
<span class="lineNum">     539 </span><span class="lineCov">          2 :         bool isNewOtterEnableNBR =false;</span>
<span class="lineNum">     540 </span><span class="lineCov">          6 :         if(inConfSharedPtr-&gt;IsIncludeNBRSession())</span>
<span class="lineNum">     541 </span>            :         {
<span class="lineNum">     542 </span><span class="lineCov">          3 :                 for(;index&lt;recordList.size();++index)</span>
<span class="lineNum">     543 </span>            :                 {
<span class="lineNum">     544 </span><span class="lineCov">          4 :                         auto record = std::dynamic_pointer_cast&lt;CDbOttersRecord&gt;(recordList[index]);</span>
<span class="lineNum">     545 </span><span class="lineCov">          3 :                         JsonValue extendInfo;</span>
<span class="lineNum">     546 </span><span class="lineCov">          2 :                         JsonReader().parse(record-&gt;ExtendInfo(),extendInfo);</span>
<span class="lineNum">     547 </span><span class="lineCov">          2 :                         if(extendInfo[JSON_KEY_ENABLE_RECORDING].isBool() &amp;&amp; extendInfo[JSON_KEY_ENABLE_RECORDING].asBool())</span>
<span class="lineNum">     548 </span>            :                         {
<span class="lineNum">     549 </span><span class="lineCov">          1 :                                 isNewOtterEnableNBR = true;</span>
<span class="lineNum">     550 </span><span class="lineCov">          1 :                                 break;</span>
<span class="lineNum">     551 </span>            :                         }
<span class="lineNum">     552 </span>            :                 }
<span class="lineNum">     553 </span>            :                 // if there are nbr session,but we can not find a otter support nbr;just failover another session
<span class="lineNum">     554 </span><span class="lineCov">          1 :                 if(index&gt;=recordList.size())</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                         index = 0;</span>
<span class="lineNum">     556 </span>            :         }
<span class="lineNum">     557 </span><span class="lineCov">          4 :         auto record = std::dynamic_pointer_cast&lt;CDbOttersRecord&gt;(recordList[index]);</span>
<span class="lineNum">     558 </span><span class="lineCov">          6 :         inConfSharedPtr-&gt;SetOtterServer(record-&gt;IP(),record-&gt;ID(),record-&gt;Location(),isNewOtterEnableNBR);</span>
<span class="lineNum">     559 </span><span class="lineCov">          4 :         record-&gt;SetLoad(record-&gt;Load()+inConfSharedPtr-&gt;GetLoad());</span>
<span class="lineNum">     560 </span><span class="lineCov">          2 :         if(record-&gt;Load() &gt;= record-&gt;MaxLoad())</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                 DeleteMaxLoadServer(m_workOtterList, record-&gt;IP());</span>
<span class="lineNum">     562 </span><span class="lineCov">          2 :         return true;</span>
<a name="563"><span class="lineNum">     563 </span>            : }</a>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineCov">          3 : void CHippoRestorer::StopSession(int inStopReason,std::shared_ptr&lt;CDbSessSvrPairsJoinedRecord&gt; inRecord)</span>
<span class="lineNum">     566 </span>            : {
<span class="lineNum">     567 </span><span class="lineCov">         18 :         HIPPO_ASSERTE_RETURN_VOID(inRecord.get()!=nullptr);</span>
<span class="lineNum">     568 </span><span class="lineCov">         69 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::StopSession inStopReason = &quot;&lt;&lt;inStopReason&lt;&lt;&quot; inSessionId = &quot;&lt;&lt;inRecord-&gt;SessionID()&lt;&lt;&quot;inServerIp= &quot;&lt;&lt;inRecord-&gt;OtterIP());</span>
<span class="lineNum">     569 </span>            :         CHippoCommonStop mstop(
<span class="lineNum">     570 </span>            :                 m_ioService,
<span class="lineNum">     571 </span><span class="lineCov">          6 :                 inRecord-&gt;SessionID(),</span>
<span class="lineNum">     572 </span><span class="lineCov">          6 :                 inRecord-&gt;ConfID(),</span>
<span class="lineNum">     573 </span><span class="lineCov">          9 :                 inRecord-&gt;SessionType(),</span>
<span class="lineNum">     574 </span><span class="lineCov">          6 :                 inRecord-&gt;SessionStartTime(),</span>
<span class="lineNum">     575 </span><span class="lineCov">          3 :         inRecord-&gt;SessionStopTime(),</span>
<span class="lineNum">     576 </span><span class="lineCov">          6 :         inRecord-&gt;OtterIP(),</span>
<span class="lineNum">     577 </span><span class="lineCov">          9 :         inRecord-&gt;SessionExtendInfo(),</span>
<span class="lineNum">     578 </span><span class="lineCov">          9 :                 inStopReason);</span>
<span class="lineNum">     579 </span><span class="lineCov">          9 :         mstop.NotificationToCB(inRecord-&gt;SessionCallbackUrl());</span>
<span class="lineNum">     580 </span><span class="lineCov">          3 :         mstop.UpdateTableSessions();</span>
<span class="lineNum">     581 </span><span class="lineCov">          3 :         mstop.UpdateSessionServerMap();</span>
<a name="582"><span class="lineNum">     582 </span>            : }</a>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span><span class="lineNoCov">          0 : void CHippoRestorer::SendStopSessionToOriginalOtter(int inStopReason, std::shared_ptr&lt;CDbSessSvrPairsJoinedRecord&gt; inRecord)</span>
<span class="lineNum">     585 </span>            : {
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :         HIPPO_ASSERTE_RETURN_VOID(inRecord.get() != nullptr);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::SendStopSessionToOriginalOtter, inStopReason=&quot; &lt;&lt; inStopReason &lt;&lt; &quot;, inSessionId=&quot; &lt;&lt; inRecord-&gt;SessionID() &lt;&lt; &quot;, inServerIp=&quot; &lt;&lt; inRecord-&gt;OtterIP());</span>
<span class="lineNum">     588 </span>            :         CHippoCommonStop mstop(
<span class="lineNum">     589 </span>            :                 m_ioService,
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                 inRecord-&gt;SessionID(),</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :                 inRecord-&gt;ConfID(),</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                 inRecord-&gt;SessionType(),</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 inRecord-&gt;SessionStartTime(),</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                 inRecord-&gt;SessionStopTime(),</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                 inRecord-&gt;OtterIP(),</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                 inRecord-&gt;SessionExtendInfo(),</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 inStopReason);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         mstop.StopOtter(inRecord-&gt;OtterIP(), CHippoConfig::GetOtterHttpPort());</span>
<span class="lineNum">     599 </span>            : }
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineCov">          2 : bool CHippoRestorer::DeleteMaxLoadServer(DbRecordListSharedPtr inServerList,const std::string &amp;inserverIp)</span>
<span class="lineNum">     602 </span>            : {
<span class="lineNum">     603 </span><span class="lineCov">         32 :         HIPPO_INFO_THIS(&quot;CHippoRestorer::DeleteMaxLoadServer,ip = &quot;&lt;&lt;inserverIp);</span>
<span class="lineNum">     604 </span><span class="lineCov">          4 :         if(nullptr == inServerList.get())</span>
<span class="lineNum">     605 </span>            :                 return false;
<span class="lineNum">     606 </span><span class="lineCov">          2 :         auto iter = inServerList-&gt;begin();</span>
<span class="lineNum">     607 </span><span class="lineCov">          5 :         for(;iter != inServerList-&gt;end(); ++iter)</span>
<span class="lineNum">     608 </span>            :         {
<span class="lineNum">     609 </span><span class="lineCov">          2 :                 std::string  mIP= (std::dynamic_pointer_cast&lt;CDbOttersRecord&gt;(*iter))-&gt;IP();</span>
<span class="lineNum">     610 </span><span class="lineCov">          1 :                 if(mIP.compare(inserverIp) == 0)</span>
<span class="lineNum">     611 </span>            :                 {
<span class="lineNum">     612 </span><span class="lineCov">          2 :                         inServerList-&gt;erase(iter);</span>
<span class="lineNum">     613 </span><span class="lineCov">          1 :                         return true;</span>
<span class="lineNum">     614 </span>            :                 }
<a name="615"><span class="lineNum">     615 </span>            :         }</a>
<span class="lineNum">     616 </span>            :         return false;
<span class="lineNum">     617 </span><span class="lineCov">          9 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
